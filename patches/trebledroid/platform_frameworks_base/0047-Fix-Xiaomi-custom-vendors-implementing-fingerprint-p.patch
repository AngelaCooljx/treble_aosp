From 452b24ee1d545f4288392710099f6b2e580bfe06 Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Fri, 26 Jan 2024 06:40:49 -0500
Subject: [PATCH 47/55] Fix Xiaomi custom vendors implementing fingerprint
 properly

---
 .../src/com/android/systemui/biometrics/UdfpsView.kt     | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsView.kt b/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsView.kt
index 48e87cb6ecb2..fa0e57436c82 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsView.kt
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsView.kt
@@ -187,8 +187,13 @@ class UdfpsView(
     val hasSamsungMask = File(samsungActualMaskBrightness).exists()
     var fodFileObserver: FileObserver? = null
 
-   val xiaomiDispParam = "/sys/class/mi_display/disp-DSI-0/disp_param"
-    var hasXiaomiLhbm = File(xiaomiDispParam).exists()
+    val xiaomiDispParam = "/sys/class/mi_display/disp-DSI-0/disp_param"
+    var hasXiaomiLhbm = try {
+            val xiaomiFingerprintService = IXiaomiFingerprint.getService()
+            File(xiaomiDispParam).exists() && xiaomiFingerprintService != null
+        } catch(e: Exception) {
+            false
+        }
 
     private val handlerThread = HandlerThread("UDFPS").also { it.start() }
     val myHandler = Handler(handlerThread.looper)
-- 
2.34.1

