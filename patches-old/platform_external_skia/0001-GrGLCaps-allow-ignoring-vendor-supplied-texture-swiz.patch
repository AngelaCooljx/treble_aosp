From dba06f6c180bceca5c01a65a9b9de8763bbd5cf5 Mon Sep 17 00:00:00 2001
From: Peter Cai <peter@typeblog.net>
Date: Tue, 22 Sep 2020 10:38:04 +0200
Subject: [PATCH] GrGLCaps: allow ignoring vendor-supplied texture swizzle flag

* This is broken on MTK 8.1 vendor

Change-Id: I1ccae06f643f01e4ea6539e1d4e3c7df8d6e30ae
---
 Android.bp              | 1 +
 src/gpu/gl/GrGLCaps.cpp | 8 ++++++++
 2 files changed, 9 insertions(+)

diff --git a/Android.bp b/Android.bp
index 122324c6ef..5ec949966a 100644
--- a/Android.bp
+++ b/Android.bp
@@ -918,6 +918,7 @@ cc_library_static {
 cc_library_static {
     name: "libskia",
     host_supported: true,
+    shared_libs: [ "libbase" ],
     cppflags:[
         // Exceptions are necessary for SkRawCodec.
         // FIXME: Should we split SkRawCodec into a separate target so the rest
diff --git a/src/gpu/gl/GrGLCaps.cpp b/src/gpu/gl/GrGLCaps.cpp
index 6a1bf56474..df007ba70c 100644
--- a/src/gpu/gl/GrGLCaps.cpp
+++ b/src/gpu/gl/GrGLCaps.cpp
@@ -23,6 +23,11 @@
 #include "src/gpu/gl/GrGLTexture.h"
 #include "src/utils/SkJSONWriter.h"
 
+#if defined(SK_BUILD_FOR_ANDROID)
+#include "android-base/properties.h"
+using android::base::GetBoolProperty;
+#endif
+
 #if defined(SK_BUILD_FOR_IOS)
 #include <TargetConditionals.h>
 #endif
@@ -270,6 +275,9 @@ void GrGLCaps::init(const GrContextOptions& contextOptions,
             fTextureSwizzleSupport = true;
         }
     } // no WebGL support
+    if(GetBoolProperty("ro.skia.ignore_swizzle", false)) {
+        fTextureSwizzleSupport = true;
+    }
 
     if (GR_IS_GR_GL(standard)) {
         fMipmapLevelControlSupport = true;
-- 
2.25.1

